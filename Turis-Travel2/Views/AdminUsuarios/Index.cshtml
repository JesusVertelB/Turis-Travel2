@model List<Turis_Travel2.Models.Usuario>

@{
    ViewData["Title"] = "Gestión de Usuarios";
    Layout = "~/Views/Shared/_LayoutDashboard.cshtml";
}

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">

<style>
    .user-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        object-fit: cover;
    }

    .table-hover tbody tr:hover {
        background-color: #f5f7fb !important;
        cursor: pointer;
    }

    .search-box input {
        border-radius: 10px;
    }

    .filter-box select {
        border-radius: 10px;
    }

    .badge-role {
        font-size: 0.75rem;
        padding: 6px 10px;
        border-radius: 15px;
    }

    .status-dot {
        height: 10px;
        width: 10px;
        display: inline-block;
        border-radius: 50%;
        margin-right: 6px;
    }

    .pagination .page-link {
        border-radius: 8px !important;
    }

    .pagination li{
        margin: 0 4px;
    }


</style>

<div class="container mt-4">

    <!-- Breadcrumb -->
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="/Dashboard">Inicio</a></li>
            <li class="breadcrumb-item active" aria-current="page">Gestión de Usuarios</li>
        </ol>
    </nav>

    <!-- Title -->
    <div class="d-flex justify-content-between align-items-center">
        <div>
            <h2 class="fw-bold">Gestión de Usuarios</h2>
            <p class="text-muted">Administra los usuarios, roles y permisos del sistema.</p>
        </div>

        <a href="/AdminUsuarios/Create" class="btn btn-primary">
            <i class="bi bi-plus-lg"></i> Añadir Nuevo Usuario
        </a>
    </div>

    <!-- Search and filters -->
    <form method="get"
      asp-action="Index"
      asp-controller="AdminUsuarios"
      class="card shadow-sm p-3 mt-3"
      id="filtrosForm">

    <div class="row g-3">

        <div class="col-md-5 search-box">
            <input type="text"
                   id="search"
                   name="search"
                   value="@ViewBag.Search"
                   class="form-control"
                   placeholder="Buscar por nombre o correo..." />
        </div>

        <div class="col-md-3 filter-box">
            <select id="estado"
                    name="estado"
                    class="form-select">
                <option value="">Estado: Todos</option>
                <option value="1" selected="@(ViewBag.EstadoActual == 1)">Activo</option>
                <option value="0" selected="@(ViewBag.EstadoActual == 0)">Inactivo</option>
                <option value="2" selected="@(ViewBag.EstadoActual == 2)">Pendiente</option>
            </select>
        </div>

    </div>
</form>


    <!-- Table -->
    <div class="card mt-4 shadow-sm">
        <div class="card-body p-0">

            <table class="table table-hover align-middle mb-0">
                <thead class="table-light">
                    <tr>
                        <th>Usuario</th>
                        <th>Rol</th>
                        <th>Estado</th>
                        <th>Último Acceso</th>
                        <th class="text-end">Acciones</th>
                    </tr>
                </thead>

                <tbody id="tablaUsuarios">
                    @foreach (var u in Model)
                    {
                        <tr>
                            <!-- Usuario + foto -->
                            <td>
                                <div class="d-flex align-items-center">
                                    <img src="https://ui-avatars.com/api/?name=@u.NombreUsuario&background=random"
                                         class="user-avatar me-3" />

                                    <div>
                                        <strong>@u.NombreUsuario</strong><br />
                                        <small class="text-muted">@u.Correo</small>
                                    </div>
                                </div>
                            </td>

                            <!-- Rol -->
                            <td>
                                <span class="badge badge-role
                                        @(u.IdRolNavigation?.NombreRol == "Admin" ? "bg-primary" :
                                                                            u.IdRolNavigation?.NombreRol == "Soporte" ? "bg-warning text-dark" :
                                                                            "bg-secondary")">
                                    @u.IdRolNavigation?.NombreRol
                                </span>
                            </td>

                            <!-- Estado -->
                            <td>
                                @{
                                    string estado = "Activo"; // puedes mapear de tu BD
                                    string color = estado == "Activo" ? "green" :
                                    estado == "Inactivo" ? "gray" :
                                    "orange";
                                }
                                <span class="status-dot" style="background:@color"></span> @estado
                            </td>

                            <!-- Último acceso (puedes agregar la columna luego) -->
                            <td class="text-muted">Nunca</td>

                            <!-- Acciones -->
                            <td class="text-end">
                                <a asp-action="Edit" asp-route-id="@u.IdUsuario" class="btn btn-sm btn-outline-primary me-1">
                                    <i class="bi bi-pencil"></i>
                                </a>
                                <a asp-action="Details" asp-route-id="@u.IdUsuario" class="btn btn-sm btn-outline-info me-1">
                                    <i class="bi bi-eye"></i>
                                </a>
                                <a asp-action="Delete" asp-route-id="@u.IdUsuario" class="btn btn-sm btn-outline-danger">
                                    <i class="bi bi-trash"></i>
                                </a>
                            </td>
                        </tr>
                    }
                </tbody>

            </table>

            <!-- Paginación -->
<nav aria-label="Page navigation">
    <ul class="pagination justify-content-center mt-3 mb-4">
        <!-- Flecha anterior -->
        <li class="page-item @(ViewBag.Page == 1 ? "disabled" : "")">
            <a class="page-link" href="@Url.Action("Index", new { 
                search = ViewBag.Search, 
                rol = ViewBag.RolActual, 
                estado = ViewBag.EstadoActual, 
                page = ViewBag.Page - 1 })">«</a>
        </li>

        <!-- Números de página -->
        @for (int i = 1; i <= ViewBag.TotalPages; i++)
        {
            <li class="page-item @(ViewBag.Page == i ? "active" : "")">
                <a class="page-link" href="@Url.Action("Index", new { 
                    search = ViewBag.Search, 
                    rol = ViewBag.RolActual, 
                    estado = ViewBag.EstadoActual, 
                    page = i })">@i</a>
            </li>
        }

        <!-- Flecha siguiente -->
        <li class="page-item @(ViewBag.Page == ViewBag.TotalPages ? "disabled" : "")">
            <a class="page-link" href="@Url.Action("Index", new { 
                search = ViewBag.Search, 
                rol = ViewBag.RolActual, 
                estado = ViewBag.EstadoActual, 
                page = ViewBag.Page + 1 })">»</a>
        </li>
    </ul>
</nav>


        </div>
    </div>

    <script>
    const form = document.getElementById("filtrosForm");
    const search = document.getElementById("search");
    const estado = document.getElementById("estado");

    let delay = null;

    search.addEventListener("keyup", () => {
        clearTimeout(delay);
        delay = setTimeout(() => {
            form.submit();
        }, 500);
    });

    estado.addEventListener("change", () => {
        form.submit();
    });
</script>

   


</div>
