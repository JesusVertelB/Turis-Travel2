@{
    Layout = "_LayoutDashboard";
}

<!-- HEADER SUPERIOR -->
<div class="top-bar">
    <h1 class="dashboard-title">Panel de Control</h1>
</div>
<h4 class="dashboard-subtitle">Resumen general del sistema</h4>

<div class="stats-grid">

    <!-- CLIENTES -->
    <div class="stat-card">
        <h4>Clientes</h4>
        <h2 id="totalClientes">0</h2>
        <span class="growth @(ViewBag.CrecimientoClientes >= 0 ? "growth-up" : "growth-down")">
            @(ViewBag.CrecimientoClientes >= 0 ? "▲" : "▼")
            @ViewBag.CrecimientoClientes%
        </span>
    </div>

    <!-- RESERVAS -->
    <div class="stat-card">
        <h4>Reservas Activas</h4>
        <h2 id="reservasActivas">0</h2>
        <span class="growth @(ViewBag.CrecimientoReservas >= 0 ? "growth-up" : "growth-down")">
            @(ViewBag.CrecimientoReservas >= 0 ? "▲" : "▼")
            @ViewBag.CrecimientoReservas%
        </span>
    </div>

    <!-- PAQUETES -->
    <div class="stat-card">
        <h4>Paquetes</h4>
        <h2 id="totalPaquetes">0</h2>
        <span class="growth growth-up">
            ▲ 0%
        </span>
    </div>

</div>


<!-- GRÁFICAS -->
<div class="charts-grid">
    <div class="chart-card">
        <h5>Destinos más visitados</h5>
        <canvas id="chartDestinos"></canvas>
    </div>
    <div class="chart-card">
        <h5>Usuarios nuevos</h5>
        <canvas id="chartUsuarios"></canvas>
    </div>
</div>

<div class="table-card">
    <h5 class="table-title">Reservas pendientes</h5>

    <div class="table-responsive">
        <table class="dashboard-table">
            <thead>
                <tr>
                    <th>Cliente</th>
                    <th>Paquete</th>
                    <th>Pasajeros</th>
                    <th>Estado</th>
                    <th>Fecha</th>
                    <th>Total</th>
                </tr>
            </thead>
            <tbody>
@foreach (var r in ViewBag.ReservasPendientes)
{
    <tr>
        <td>
            @r.IdClienteNavigation?.Nombre
        </td>

        <td>
            @r.IdPaqueteNavigation?.NombrePaquete
        </td>

        <td>
            @r.NumeroPasajeros
        </td>

        <td>
            <span class="badge badge-warning">
                @r.Estado
            </span>
        </td>

        <td>
            @r.FechaSolicitud?.ToString("dd/MM/yyyy")
        </td>

        <td>
            $@r.PrecioTotal
        </td>
    </tr>
}
</tbody>

        </table>
    </div>
</div>



@section Scripts {
    <script>
        let chartDestinos;
        let chartUsuarios;

        function cargarDashboard() {
            fetch('/Dashboard/DatosDashboard')
                .then(res => res.json())
                .then(data => {

                    // CARDS
                    document.querySelectorAll('.stat-card h2')[0].innerText = data.totalClientes;
                    document.querySelectorAll('.stat-card h2')[1].innerText = data.reservasActivas;
                    document.querySelectorAll('.stat-card h2')[2].innerText = data.totalPaquetes;

                    // DESTINOS
                    if (!chartDestinos) {
                        chartDestinos = new Chart(document.getElementById('chartDestinos'), {
                            type: 'bar',
                            data: {
                                labels: data.destinosLabels,
                                datasets: [{
                                    data: data.destinosData,
                                    backgroundColor: '#4CAF50'
                                }]
                            },
                            options: { plugins: { legend: { display: false } } }
                        });
                    } else {
                        chartDestinos.data.labels = data.destinosLabels;
                        chartDestinos.data.datasets[0].data = data.destinosData;
                        chartDestinos.update();
                    }

                    // CLIENTES
                    if (!chartUsuarios) {
                        chartUsuarios = new Chart(document.getElementById('chartUsuarios'), {
                            type: 'line',
                            data: {
                                labels: data.clientesLabels,
                                datasets: [{
                                    data: data.clientesData,
                                    borderColor: '#4CAF50',
                                    tension: 0.3
                                }]
                            },
                            options: { plugins: { legend: { display: false } } }
                        });
                    } else {
                        chartUsuarios.data.datasets[0].data = data.clientesData;
                        chartUsuarios.update();
                    }
                });
        }

        // cargar al inicio
        cargarDashboard();

        // refrescar cada 10 segundos
        setInterval(cargarDashboard, 10000);
    </script>
}

    
